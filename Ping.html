<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>é«˜çº§æ‹¼å›¾æ¸¸æˆ</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="game-info">
        <div>å½“å‰éš¾åº¦: <span id="current-level-display">3Ã—3</span></div>
        <div>ç”¨æ—¶: <span id="timer">00:00</span></div>
        <div>æ­¥æ•°: <span id="move-count">0</span></div>
    </div>

    <ul id="ul"></ul>

    <div class="game-controls">
        <button onclick="gameManager.resetGame()">é‡æ–°å¼€å§‹</button>
        <button onclick="gameManager.increaseDifficulty()">å¢åŠ éš¾åº¦</button>
        <button onclick="gameManager.decreaseDifficulty()">é™ä½éš¾åº¦</button>
        <select onchange="gameManager.changeImage(this.value)" style="margin-left:10px;padding:4px;">
            <option value="0">é»˜è®¤å›¾ç‰‡</option>
            <option value="1">å›¾ç‰‡1</option>
            <option value="2">å›¾ç‰‡2</option>
        </select>
    </div>

    <div class="ranking">
        <h3>ğŸ† æ¸¸æˆæ’å</h3>
        <table class="ranking-table">
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>éš¾åº¦</th>
                    <th>ç”¨æ—¶</th>
                    <th>æ­¥æ•°</th>
                    <th>æ—¥æœŸ</th>
                </tr>
            </thead>
            <tbody id="ranking-body"></tbody>
        </table>
    </div>

    <div class="share-section">
        <button class="share-btn" onclick="gameManager.shareOnWechat()">å¾®ä¿¡åˆ†äº«</button>
        <button class="share-btn" onclick="gameManager.shareOnQQ()">QQåˆ†äº«</button>
        <button class="share-btn" onclick="gameManager.copyGameLink()">å¤åˆ¶é“¾æ¥</button>
        <button class="share-btn" onclick="gameManager.clearRecord()" style="background: #e74c3c;">æ¸…é™¤è®°å½•</button>
    </div>

    <script>
        // ES6 Class å®ç°æ‹¼å›¾æ¸¸æˆ
        class PuzzleGame {
            constructor() {
                this.oUl = null;
                this.aLi = null;
                this.len = 0;
                this.oLi = null;
                this.num = 0;
                this.zIndex = 2;
                this.arr = [];
            }

            init(id, num) {
                this.oUl = document.querySelector(id);
                this.oUl.innerHTML = this.generatePieces(num);
                this.aLi = this.oUl.querySelectorAll("li");
                this.len = this.aLi.length;
                this.num = num;

                this.oLi = this.aLi[this.len - 1];
                this.oLi.className = 'active';
                this.positionPieces();
                this.bindClickEvents();
                this.jian();
            }

            // åˆ¤æ–­æ˜¯å¦å®Œæˆæ‹¼å›¾
            checkPing() {
                let arr1 = [];
                let arr2 = [];
                let n = 0;

                for (let i = 0; i < this.len; i++) {
                    arr1.push(this.aLi[i].index);
                    arr2.push(this.arr[i][2]);
                }

                for (let i = 0; i < this.len; i++) {
                    if (arr1[i] === arr2[i]) {
                        n += 1;
                    }
                }

                if (n === this.len) {
                    alert('é—¯å…³æˆåŠŸ');
                    this.num++;

                    if (this.num <= 8) {
                        setTimeout(() => {
                            this.init('ul', this.num);
                        }, 1000);
                    } else {
                        alert('æ­å–œï¼ä½ å·²é€šå…³æ‰€æœ‰éš¾åº¦ï¼');
                        this.num = 8;
                    }

                    return true;
                }
                return false;
            }

            // é€šè¿‡indexæ‰¾åˆ°li
            findLiByIndex(index) {
                for (let i = 0; i < this.len; i++) {
                    if (this.aLi[i].index === index) {
                        return this.aLi[i];
                    }
                }
                return null;
            }

            // é”®ç›˜ç§»åŠ¨
            jian() {
                document.onkeydown = (ev) => {
                    ev = ev || event;
                    let targetLi = null;

                    switch (ev.keyCode) {
                        case 37: // å·¦
                            if (this.oLi.index - 1 >= 0) {
                                targetLi = this.findLiByIndex(this.oLi.index - 1);
                            }
                            break;
                        case 39: // å³
                            if (this.oLi.index + 1 <= this.len - 1) {
                                targetLi = this.findLiByIndex(this.oLi.index + 1);
                            }
                            break;
                        case 38: // ä¸Š
                            if (this.oLi.index - this.num >= 0) {
                                targetLi = this.findLiByIndex(this.oLi.index - this.num);
                            }
                            break;
                        case 40: // ä¸‹
                            if (this.oLi.index + this.num <= this.len - 1) {
                                targetLi = this.findLiByIndex(this.oLi.index + this.num);
                            }
                            break;
                    }

                    if (targetLi) {
                        this.move(targetLi);
                    }
                };
            }

            // åˆ¤æ–­æ˜¯å¦å¯ä»¥ç§»åŠ¨
            canMove(li) {
                const index = li.index;
                const num = this.oLi.index;

                if (num % this.num === 0) { // å·¦è¾¹ç•Œ
                    return index + this.num === num || index - this.num === num || index - 1 === num;
                } else if (num % this.num === this.num - 1) { // å³è¾¹ç•Œ
                    return index + this.num === num || index - this.num === num || index + 1 === num;
                } else { // ä¸­é—´
                    return index + this.num === num || index - this.num === num || index - 1 === num || index + 1 === num;
                }
            }

            // ç§»åŠ¨
            move(li) {
                if (this.canMove(li)) {
                    li.style.left = this.arr[this.oLi.index][0] + 'px';
                    li.style.top = this.arr[this.oLi.index][1] + 'px';
                    this.oLi.style.left = this.arr[li.index][0] + 'px';
                    this.oLi.style.top = this.arr[li.index][1] + 'px';

                    [this.oLi.index, li.index] = [li.index, this.oLi.index];

                    // è°ƒç”¨æ­¥æ•°ç§»åŠ¨è®¡ç®—
                    if (typeof gameManager !== 'undefined') {
                        gameManager.incrementMoveCount();
                    }

                    return this.checkPing();
                }
                return false;
            }

            // ç‚¹å‡»äº‹ä»¶
            bindClickEvents() {
                for (let i = 0; i < this.len; i++) {
                    this.aLi[i].onclick = () => {
                        this.aLi[i].style.zIndex = this.zIndex++;
                        this.move(this.aLi[i]);
                    };
                }
            }

            // å®šä½æ‹¼å›¾å—
            positionPieces() {
                let arr1 = [];
                let arrA = [];

                for (let i = 0; i < this.len; i++) {
                    arr1.push([this.aLi[i].offsetLeft, this.aLi[i].offsetTop, i]);
                    arrA.push([this.aLi[i].offsetLeft, this.aLi[i].offsetTop, i]);
                }

                this.arr = arrA;

                // éšæœºæ’åº
                let arr2 = [];
                for (let i = 0; i < this.len - 1; i++) {
                    arr2.push(arr1[i]);
                }

                // arr2.sort(() => Math.random() - 0.5);
                arr2.push(arr1[this.len - 1]);

                // æ£€æŸ¥å¯è§£æ€§
                let arr3 = [];
                let inversionCount = 0;

                for (let i = 0; i < this.len; i++) {
                    arr3.push(arr2[i][2]);
                }

                for (let i = 0; i < this.len; i++) {
                    let b = arr3[i];
                    for (let j = i; j < this.len; j++) {
                        let c = arr3[j];
                        if (b > c) {
                            inversionCount += 1;
                        }
                    }
                }

                if (inversionCount % 2 === 0) {
                    console.log('åŠ æ²¹');
                } else {
                    console.log('ä½ ä¸ä¼šæˆåŠŸçš„');
                    this.positionPieces();
                    return false;
                }

                arr1 = arr2;

                for (let i = 0; i < this.len; i++) {
                    // if (this.num >= 5) {
                        this.aLi[i].innerHTML = i + 1;
                    // }

                    this.aLi[i].style.position = 'absolute';
                    this.aLi[i].style.left = arr1[i][0] + 'px';
                    this.aLi[i].style.top = arr1[i][1] + 'px';
                    this.aLi[i].index = arr1[i][2];
                    this.aLi[i].style.margin = 0;
                    this.aLi[i].style.backgroundSize = this.num * 100 + 'px';
                    this.aLi[i].style.backgroundPosition =
                        (i % this.num) * -100 + "px " +
                        ((i - (i % this.num)) / this.num) * -100 + "px";
                }
            }

            // ç”Ÿæˆæ‹¼å›¾å—
            generatePieces(num) {
                this.oUl.style.width = 2 + num * 2 + num * 100 + "px";
                this.oUl.style.height = num * 2 + num * 100 + "px";

                let n = num * num;
                let str = '';
                for (let i = 0; i < n; i++) {
                    str += "<li></li>";
                }
                return str;
            }


        }

        // æ¸¸æˆç®¡ç†å™¨ç±»
        class GameManager {
            constructor() {
                this.puzzleGame = null;
                this.startTime = null;
                this.timerInterval = null;
                this.moveCount = 0;
                this.currentLevel = 3;
                this.gameStarted = false;
                this.imageSources = [
                    'bili.jpg', 
                    'img1.jpg', 
                    'img3.jpg', 
                ];
                this.currentImageIndex = 0;
            }

            init(puzzleGame) {
                this.puzzleGame = puzzleGame;
                this.updateLevelDisplay();
                this.loadRankings();
                this.showImagePreview();
                this.overridePuzzleGameMethods();
            }

            // é‡å†™æ‹¼å›¾æ¸¸æˆæ–¹æ³•
            overridePuzzleGameMethods() {
                const originalMove = this.puzzleGame.move.bind(this.puzzleGame);
                const originalCheckPing = this.puzzleGame.checkPing.bind(this.puzzleGame);
                const originalInit = this.puzzleGame.init.bind(this.puzzleGame);

                // é‡å†™moveæ–¹æ³•
                this.puzzleGame.move = (li) => {
                    // ç¬¬ä¸€æ¬¡ç§»åŠ¨æ—¶å¼€å§‹è®¡æ—¶
                    if (!this.gameStarted) {
                        this.hideImagePreview();
                        this.startTimer();
                        this.gameStarted = true;
                    }

                    if (originalMove(li)) {
                        this.moveCount++;
                        document.getElementById('move-count').textContent = this.moveCount;
                        return true;
                    }
                    return false;
                };

                // é‡å†™checkPingæ–¹æ³•
                this.puzzleGame.checkPing = () => {
                    if (originalCheckPing()) {
                        // è®°å½•æˆç»©
                        this.recordScore();
                        this.currentLevel++;
                        this.updateLevelDisplay();

                        setTimeout(() => {
                            this.puzzleGame.init('ul', this.puzzleGame.num);
                            // é‡ç½®æ¸¸æˆçŠ¶æ€å¹¶æ˜¾ç¤ºæ–°å›¾ç‰‡
                            this.updatePuzzleBackground();
                            this.resetState();
                            this.showImagePreview();
                        }, 1000);
                        return true;
                    }
                    return false;
                };

                // é‡å†™initæ–¹æ³•ä»¥åŒæ­¥éš¾åº¦
                this.puzzleGame.init = (id, num) => {
                    this.currentLevel = num;
                    this.updateLevelDisplay();
                    return originalInit(id, num);
                };
            }


            //åˆ‡æ¢å›¾ç‰‡
            changeImage(imageIndex) {
                this.currentImageIndex = Number(imageIndex); 
                this.resetGame(); 
                this.showImagePreview();
            }


            //æ›´æ–°æ‹¼å›¾ç¢ç‰‡èƒŒæ™¯å›¾
            updatePuzzleBackground() {
                if (!this.puzzleGame || !this.puzzleGame.aLi) return;
                const currentImage = this.imageSources[this.currentImageIndex]; 
                const num = this.currentLevel; 
                const pieces = this.puzzleGame.aLi;

                // å¾ªç¯ç»™æ¯ä¸ªç¢ç‰‡è®¾ç½®æ–°èƒŒæ™¯å›¾
                for (let i = 0; i < pieces.length; i++) {
                    pieces[i].style.backgroundImage = `url(${currentImage})`;
                    
                    pieces[i].style.backgroundPosition =
                        (i % num) * -100 + "px " +
                        ((i - (i % num)) / num) * -100 + "px";
                }
            }



            showImagePreview() {
                // ç§»é™¤å·²å­˜åœ¨çš„é¢„è§ˆå±‚
                const existingPreview = document.querySelector('.image-preview');
                if (existingPreview) {
                    existingPreview.remove();
                }

                // åˆ›å»ºæ–°çš„é¢„è§ˆå±‚ï¼ˆä½¿ç”¨å½“å‰é€‰ä¸­çš„å›¾ç‰‡ï¼‰
                const preview = document.createElement('div');
                preview.className = 'image-preview';
                preview.style.backgroundImage = `url(${this.imageSources[this.currentImageIndex]})`;
                document.getElementById('ul').appendChild(preview);

                // ç‚¹å‡»äº‹ä»¶
                preview.addEventListener('click', () => {
                    this.hideImagePreview();
                    this.startTimer();
                    this.gameStarted = true;
                });
            }

            // éšè—å®Œæ•´å›¾ç‰‡
            hideImagePreview() {
                const preview = document.querySelector('.image-preview');
                if (preview) {
                    preview.classList.add('hidden');
                    // 1ç§’åå®Œå…¨ç§»é™¤
                    setTimeout(() => {
                        if (preview.parentNode) {
                            preview.parentNode.removeChild(preview);
                        }
                    }, 500);
                }
            }

            // è®¡æ—¶å™¨
            startTimer() {
                this.startTime = new Date();
                this.timerInterval = setInterval(() => {
                    const now = new Date();
                    const diff = Math.floor((now - this.startTime) / 1000);
                    const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
                    const seconds = (diff % 60).toString().padStart(2, '0');
                    document.getElementById('timer').textContent = `${minutes}:${seconds}`;
                }, 1000);
            }

            // é‡ç½®æ¸¸æˆ
            resetGame() {
                this.resetState();
                this.puzzleGame.init("ul", this.currentLevel);
                this.updatePuzzleBackground();
            }

            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            resetState() {
                clearInterval(this.timerInterval);
                this.moveCount = 0;
                this.gameStarted = false;
                document.getElementById('move-count').textContent = '0';
                document.getElementById('timer').textContent = '00:00';
            }

            // å¢åŠ éš¾åº¦
            increaseDifficulty() {
                if (this.currentLevel < 8) {
                    this.currentLevel++;
                    this.updateLevelDisplay();
                    this.resetGame();
                } else {
                    alert('å·²ç»æ˜¯æœ€é«˜éš¾åº¦äº†ï¼');
                }
            }

            // ç§»åŠ¨è®¡æ•°
            incrementMoveCount() {
                this.moveCount++;
                document.getElementById('move-count').textContent = this.moveCount;
            }

            // æ¸…é™¤è®°å½•
            clearRecord() {
                if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ¸¸æˆè®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    localStorage.removeItem('puzzleRankings');
                    this.loadRankings();
                    alert('æ¸¸æˆè®°å½•å·²æ¸…é™¤ï¼');
                }
            }

            // é™ä½éš¾åº¦
            decreaseDifficulty() {
                if (this.currentLevel > 3) {
                    this.currentLevel--;
                    this.updateLevelDisplay();
                    this.resetGame();
                } else {
                    alert('å·²ç»æ˜¯æœ€ä½éš¾åº¦äº†ï¼');
                }
            }

            // æ›´æ–°æ˜¾ç¤ºå½“å‰ç­‰çº§
            updateLevelDisplay() {
                document.getElementById('current-level-display').textContent = `${this.currentLevel}Ã—${this.currentLevel}`;
                // åŒæ­¥æ›´æ–°PuzzleGameå®ä¾‹çš„éš¾åº¦
                if (this.puzzleGame) {
                    this.puzzleGame.num = this.currentLevel;
                }
            }

            // è®°å½•æˆç»©
            recordScore() {
                const time = document.getElementById('timer').textContent;
                const moves = this.moveCount;
                const level = this.currentLevel;

                console.log('è®°å½•æˆç»©:', { level, time, moves });

                const score = {
                    level: level,
                    time: time,
                    moves: moves,
                    date: new Date().toLocaleString('zh-CN')
                };

                let rankings = JSON.parse(localStorage.getItem('puzzleRankings') || '[]');
                rankings.push(score);

                // æŒ‰æ—¶é—´æ’åº
                rankings.sort((a, b) => {
                    const [aMin, aSec] = a.time.split(':').map(Number);
                    const [bMin, bSec] = b.time.split(':').map(Number);
                    return (aMin * 60 + aSec) - (bMin * 60 + bSec);
                });

                // åªä¿ç•™å‰5å
                rankings = rankings.slice(0, 5);
                localStorage.setItem('puzzleRankings', JSON.stringify(rankings));

                this.loadRankings();
            }

            // å°†ä¿¡æ¯ä¿å­˜åˆ°æœ¬åœ°å¹¶æ˜¾ç¤º
            loadRankings() {
                const rankings = JSON.parse(localStorage.getItem('puzzleRankings') || '[]');
                const tbody = document.getElementById('ranking-body');
                tbody.innerHTML = '';

                if (rankings.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">æš‚æ— è®°å½•</td></tr>';
                    return;
                }

                rankings.forEach((score, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${score.level}Ã—${score.level}</td>
                        <td>${score.time}</td>
                        <td>${score.moves}</td>
                        <td>${score.date}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            shareOnWechat() {
                alert('è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æåˆ†äº«é¡µé¢ï¼\næ¸¸æˆæˆç»©ï¼š' +
                    document.getElementById('timer').textContent + ' ç”¨æ—¶ï¼Œ' +
                    this.moveCount + ' æ­¥æ•°');
            }

            shareOnQQ() {
                alert('å·²ç”ŸæˆQQåˆ†äº«é“¾æ¥ï¼\næ¸¸æˆæˆç»©ï¼š' +
                    document.getElementById('timer').textContent + ' ç”¨æ—¶ï¼Œ' +
                    this.moveCount + ' æ­¥æ•°');
            }

            copyGameLink() {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('æ¸¸æˆé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }).catch(() => {
                    const textArea = document.createElement('textarea');
                    textArea.value = window.location.href;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('æ¸¸æˆé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                });
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        window.onload = function () {
            const puzzleGame = new PuzzleGame();
            puzzleGame.init("ul", 3);

            // åˆå§‹åŒ–æ¸¸æˆç®¡ç†å™¨
            gameManager.init(puzzleGame);
            gameManager.updatePuzzleBackground();
        }

        // åˆ›å»ºå…¨å±€æ¸¸æˆç®¡ç†å™¨å®ä¾‹
        const gameManager = new GameManager();
    </script>
</body>


</html>
