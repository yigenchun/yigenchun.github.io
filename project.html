<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>é«˜çº§æ‹¼å›¾æ¸¸æˆ</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <style>
        body,
        ul {
            margin: 0;
            padding: 0;
        }

        #ul {
            background: lemonchiffon;
            width: 308px;
            height: 306px;
            position: relative;
            padding-top: 2px;
            border: 4px solid #000;
            border-radius: 4px;
            margin: 20px auto;
        }

        #ul li {
            width: 100px;
            height: 100px;
            list-style-type: none;
            background: url(bili.jpg) pink;
            float: left;
            margin: 0 0 2px 2px;

            line-height: 100px;
            text-align: center;
            color: white;
            text-shadow: 1px 1px 1px #000;
            font-size: 20px;
        }

        #ul li.active {
            background: lemonchiffon;
        }

        /* æ–°å¢æ ·å¼ */
        .game-controls {
            text-align: center;
            margin: 20px 0;
        }

        .game-info {
            text-align: center;
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
        }

        .ranking {
            max-width: 600px;
            margin: 20px auto;
            padding: 15px;
            border: 2px solid #333;
            border-radius: 10px;
            background: #f9f9f9;
        }

        .ranking h3 {
            text-align: center;
            margin-bottom: 10px;
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ranking-table th,
        .ranking-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .ranking-table th {
            background-color: #4CAF50;
            color: white;
        }

        .share-section {
            text-align: center;
            margin: 20px 0;
        }

        .share-btn {
            padding: 10px 20px;
            margin: 5px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .share-btn:hover {
            background: #3367d6;
        }

        .current-level {
            font-size: 20px;
            font-weight: bold;
            color: #e74c3c;
            margin: 10px 0;
        }

         /* å®Œæ•´å›¾ç‰‡é¢„è§ˆå±‚ */
    .image-preview {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        z-index: 999;
        border-radius: 4px;
        transition: opacity 0.5s ease;
    }
    
    .image-preview.hidden {
        opacity: 0;
        pointer-events: none;
    }
    </style>
</head>

<body>
    <div class="game-info">
        <div>å½“å‰éš¾åº¦: <span id="current-level-display">3Ã—3</span></div>
        <div>ç”¨æ—¶: <span id="timer">00:00</span></div>
        <div>æ­¥æ•°: <span id="move-count">0</span></div>
    </div>

    <ul id="ul">
        <!-- <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li class="active"></li> -->
    </ul>

    <!-- æ¸¸æˆæ§åˆ¶ -->
    <div class="game-controls">
        <button onclick="gameManager.resetGame()">é‡æ–°å¼€å§‹</button>
        <button onclick="gameManager.increaseDifficulty()">å¢åŠ éš¾åº¦</button>
        <button onclick="gameManager.decreaseDifficulty()">é™ä½éš¾åº¦</button>
    </div>

    <!-- æ’åæ˜¾ç¤º -->
    <div class="ranking">
        <h3>ğŸ† æ¸¸æˆæ’å</h3>
        <table class="ranking-table">
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>éš¾åº¦</th>
                    <th>ç”¨æ—¶</th>
                    <th>æ­¥æ•°</th>
                    <th>æ—¥æœŸ</th>
                </tr>
            </thead>
            <tbody id="ranking-body">
                <!-- æ’åæ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </tbody>
        </table>
    </div>

    <!-- åˆ†äº«åŠŸèƒ½ -->
    <div class="share-section">
        <button class="share-btn" onclick="gameManager.shareOnWechat()">å¾®ä¿¡åˆ†äº«</button>
        <button class="share-btn" onclick="gameManager.shareOnQQ()">QQåˆ†äº«</button>
        <button class="share-btn" onclick="gameManager.copyGameLink()">å¤åˆ¶é“¾æ¥</button>
        <button class="share-btn" onclick="gameManager.clearRecord()" style="background: #e74c3c;">æ¸…é™¤è®°å½•</button>
    </div>
</body>

<script>
    // æ‚¨çš„åŸæœ‰ä»£ç ä¿æŒä¸å˜
    window.onload = function () {
        let p1 = new Ping();
        p1.init("ul", 3);

        // åˆå§‹åŒ–æ¸¸æˆç®¡ç†å™¨
        gameManager.init(p1);
    }

    function Ping() {
        this.oUl = null;;
        this.aLi = null;
        this.len = 0;
        this.oLi = null;
        this.num = 0;
        this.zIndex = 2;
        this.arr = [];
    }
    Ping.prototype.init = function (id, num) {
        this.oUl = document.querySelector(id);
        this.oUl.innerHTML = this.sheng(num);
        this.aLi = this.oUl.querySelectorAll("li");
        this.len = this.aLi.length;
        console.log(this.aLi.length)
        this.num = num;

        this.oLi = this.aLi[this.len - 1];
        this.oLi.className = 'active';
        this.ding();
        this.click();
        this.jian()

    }

    //åˆ¤æ–­åˆå¹¶
    Ping.prototype.he = function () {
        let arr1 = []
        let arr2 = []
        let n = 0
        for (let i = 0; i < this.len; i++) {
            arr1.push(this.aLi[i].index)
            arr2.push(this.arr[i][2])

        }
        for (let i = 0; i < this.len; i++) {
            if (arr1[i] == arr2[i]) {
                n += 1
            }

        }
        if (n == this.len) {
            alert('é—¯å…³æˆåŠŸ')
            this.num++
            let This = this
            if (This.num <= 8) {
                setTimeout(function () {
                    This.init('ul', This.num)
                }, 1000)
            } else {
                alert('æ­å–œï¼ä½ å·²é€šå…³æ‰€æœ‰éš¾åº¦ï¼')
                this.num = 8
            }
        }
    }
    //é€šè¿‡indexæ‰¾åˆ°li
    Ping.prototype.Li = function (index) {
        for (let i = 0; i < this.len; i++) {
            if (this.aLi[i].index == index) {
                return this.aLi[i]
            }
        }
    }
    //é”®ç›˜ç§»åŠ¨
    Ping.prototype.jian = function () {
        let This = this
        document.onkeydown = function (ev) {

            ev = ev || event;
            if (ev.keyCode == 37) {//zuo
                console.log(ev.keyCode)
                if (This.oLi.index - 1 < 0) {
                    This.move(This.Li(This.oLi.index))
                } else {
                    This.move(This.Li(This.oLi.index - 1))

                }
            } else if (ev.keyCode == 39) {//you
                console.log(ev.keyCode)
                if (This.oLi.index + 1 > This.len - 1) {
                    This.move(This.Li(This.oLi.index))
                } else {
                    This.move(This.Li(This.oLi.index + 1))

                }

            } else if (ev.keyCode == 38) {//shang
                console.log(ev.keyCode)
                if (This.oLi.index - This.num < 0) {
                    This.move(This.Li(This.oLi.index))
                } else {
                    This.move(This.Li(This.oLi.index - This.num))

                }

            } else if (ev.keyCode == 40) {//xia
                console.log(ev.keyCode)
                if (This.oLi.index + This.num > This.len - 1) {
                    This.move(This.Li(This.oLi.index))
                } else {
                    This.move(This.Li(This.oLi.index + This.num))

                }

            }
        }
    }

    //åˆ¤æ–­æ˜¯å¦å¯ä»¥ç§»åŠ¨
    Ping.prototype.pan = function (li) {
        let index = li.index
        let num = this.oLi.index
        if (num % this.num == 0) {//zuo
            if (index + this.num == num || index - this.num == num || index - 1 == num) {
                return true
            }

        } else if (num % this.num == this.num - 1) {
            if (index + this.num == num || index - this.num == num || index + 1 == num) {
                return true
            }//you

        } else {//zhong
            if (index + this.num == num || index - this.num == num || index - 1 == num || index + 1 == num) {
                return true
            }
        }
        return false
    }
    //ç§»åŠ¨
    Ping.prototype.move = function (li) {
        if (this.pan(li)) {

            li.style.left = this.arr[this.oLi.index][0] + 'px';
            li.style.top = this.arr[this.oLi.index][1] + 'px';
            this.oLi.style.left = this.arr[li.index][0] + 'px';
            this.oLi.style.top = this.arr[li.index][1] + 'px';

            [this.oLi.index, li.index] = [li.index, this.oLi.index];

            //è°ƒç”¨æ­¥æ•°ç§»åŠ¨è®¡ç®—
            if (typeof gameManager !== 'undefined') {
                gameManager.incrementMoveCount();
            }

            this.he()
        }

    }
    //ç‚¹å‡»
    Ping.prototype.click = function () {
        let This = this;
        for (let i = 0; i < this.len; i++) {
            this.aLi[i].onclick = function () {
                this.style.zIndex = This.zIndex++;

                // console.log(this.index)
                This.move(this);
            }
        }
    }
    //å®šä½
    Ping.prototype.ding = function () {
        let arr1 = [];
        let arrA = [];
        for (let i = 0; i < this.len; i++) {
            arr1.push([this.aLi[i].offsetLeft, this.aLi[i].offsetTop, i]);
            arrA.push([this.aLi[i].offsetLeft, this.aLi[i].offsetTop, i]);
        }
        this.arr = arrA;
        //éšæœº
        let arr2 = []
        for (let i = 0; i < this.len - 1; i++) {
            arr2.push(arr1[i]);
        }
        //æ’åº
        arr2.sort(function (a, b) {
            return Math.random() - 0.5;
        })
        arr2.push(arr1[this.len - 1])
        console.log(arr2)

        let arr3 = [];
        let a = 0;
        for (let i = 0; i < this.len; i++) {
            arr3.push(arr2[i][2]);

        }
        for (let i = 0; i < this.len; i++) {
            let b = arr3[i];
            for (let j = i; j < this.len; j++) {
                let c = arr3[j];
                if (b > c) {
                    a += 1;
                }
            }
        }
        console.log(arr2);
        if (a % 2 == 0) {
            console.log('åŠ æ²¹');
        } else {
            console.log('ä½ ä¸ä¼šæˆåŠŸçš„')
            this.ding();
            return false
        }
        arr1 = arr2
        for (let i = 0; i < this.len; i++) {
            if (this.num >= 5) {
                this.aLi[i].innerHTML = i + 1
            }
            this.aLi[i].style.position = 'absolute';
            this.aLi[i].style.left = arr1[i][0] + 'px';
            this.aLi[i].style.top = arr1[i][1] + 'px';
            this.aLi[i].index = arr1[i][2];
            this.aLi[i].style.margin = 0;
            this.aLi[i].style.backgroundSize = this.num * 100 + 'px';
            this.aLi[i].style.backgroundPosition = (i % this.num) * -100 + "px " + ((i - (i % this.num)) / this.num) * -100 + "px";
        }
    }

    //ç”Ÿæˆli
    Ping.prototype.sheng = function (num) {
        this.oUl.style.width = 2 + num * 2 + num * 100 + "px";
        this.oUl.style.height = num * 2 + num * 100 + "px";

        let n = num * num;
        let str = '';
        for (let i = 0; i < n; i++) {
            str += "<li></li>";
        }
        return str;
    }

    // ï¼ï¼ï¼ï¼ï¼ï¼ï¼ æ¸¸æˆç®¡ç†å™¨ ï¼ï¼ï¼ï¼ï¼ï¼ï¼
    const gameManager = {
        pingInstance: null,
        startTime: null,
        timerInterval: null,
        moveCount: 0,
        currentLevel: 3,
        gameStarted: false,

        init: function (pingInstance) {
            this.pingInstance = pingInstance;
            this.updateLevelDisplay();
            this.loadRankings();
            //æ˜¾ç¤ºåŸå§‹å›¾ç‰‡
            this.showImagePreview();

            
            const originalMove = this.pingInstance.move;
            const originalHe = this.pingInstance.he;
            const originalInit = this.pingInstance.init;
            const self = this;

            // é‡å†™moveæ–¹æ³•
            this.pingInstance.move = function (li) {
                // ç¬¬ä¸€æ¬¡ç§»åŠ¨æ—¶å¼€å§‹è®¡æ—¶
                if (!self.gameStarted) {
                    //éšè—åŸå§‹å›¾ç‰‡
                    self.hideImagePreview();
                    self.startTimer();
                    self.gameStarted = true;
                }

                if (originalMove.call(this, li)) {
                    self.moveCount++;
                    document.getElementById('move-count').textContent = self.moveCount;
                    return true;
                }
                return false;
            };

            // é‡å†™heæ–¹æ³•
            this.pingInstance.he = function () {
                let arr1 = []
                let arr2 = []
                let n = 0
                for (let i = 0; i < this.len; i++) {
                    arr1.push(this.aLi[i].index)
                    arr2.push(this.arr[i][2])
                }
                for (let i = 0; i < this.len; i++) {
                    if (arr1[i] == arr2[i]) {
                        n += 1
                    }
                }
                if (n == this.len) {
                    // è®°å½•æˆç»©
                    self.recordScore();

                    alert('é—¯å…³æˆåŠŸ')
                    self.currentLevel++;
                    self.updateLevelDisplay();

                    let This = this
                    setTimeout(function () {
                        This.init('ul', This.num)
                        // é‡ç½®æ¸¸æˆçŠ¶æ€å¹¶æ˜¾ç¤ºæ–°å›¾ç‰‡
                        self.resetState();
                        self.showImagePreview();
                    }, 1000)
                }
            };

            // é‡å†™initæ–¹æ³•ä»¥åŒæ­¥éš¾åº¦
            this.pingInstance.init = function (id, num) {
                self.currentLevel = num;
                self.updateLevelDisplay();
                return originalInit.call(this, id, num);
            };
        },

          //æ˜¾ç¤ºå®Œæ•´å›¾ç‰‡
        showImagePreview: function() {
            // ç§»é™¤å·²å­˜åœ¨çš„é¢„è§ˆå±‚
            const existingPreview = document.querySelector('.image-preview');
            if (existingPreview) {
                existingPreview.remove();
            }
            
            // åˆ›å»ºæ–°çš„é¢„è§ˆå±‚
            const preview = document.createElement('div');
            preview.className = 'image-preview';
            preview.style.backgroundImage = 'url(bili.jpg)';
            document.getElementById('ul').appendChild(preview);
            
            // ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»å›¾ç‰‡ä¹Ÿå¯ä»¥å¼€å§‹æ¸¸æˆ
            preview.addEventListener('click', () => {
                this.hideImagePreview();
                this.startTimer();
                this.gameStarted = true;
            });
        },

        // éšè—å®Œæ•´å›¾ç‰‡
        hideImagePreview: function() {
            const preview = document.querySelector('.image-preview');
            if (preview) {
                preview.classList.add('hidden');
                // 1ç§’åå®Œå…¨ç§»é™¤
                setTimeout(() => {
                    if (preview.parentNode) {
                        preview.parentNode.removeChild(preview);
                    }
                }, 500);
            }
        },

        //è®¡æ—¶å™¨
        startTimer: function () {
            this.startTime = new Date();
            this.timerInterval = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - this.startTime) / 1000);
                const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
                const seconds = (diff % 60).toString().padStart(2, '0');
                document.getElementById('timer').textContent = `${minutes}:${seconds}`;
            }, 1000);
        },

        //é‡ç½®æ¸¸æˆ
        resetGame: function () {
            this.resetState();
            this.pingInstance.init("ul", this.currentLevel);
        },

            //é‡ç½®æ‰€æœ‰çŠ¶æ€
        resetState: function () {
            clearInterval(this.timerInterval);
            this.moveCount = 0;
            this.gameStarted = false;
            document.getElementById('move-count').textContent = '0';
            document.getElementById('timer').textContent = '00:00';
        },

        //åšé«˜éš¾åº¦åˆ¤æ–­
        increaseDifficulty: function () {
            if (this.currentLevel < 8) {
                this.currentLevel++;
                this.updateLevelDisplay();
                this.resetGame();
            } else {
                alert('å·²ç»æ˜¯æœ€é«˜éš¾åº¦äº†ï¼');
            }
        },


        //ç§»åŠ¨è®¡æ•°
        incrementMoveCount: function () {
            this.moveCount++;
            document.getElementById('move-count').textContent = this.moveCount;
        },

        //æ¸…é™¤è®°å½•
        clearRecord: function () {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ¸¸æˆè®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem('puzzleRankings');
                this.loadRankings();
                alert('æ¸¸æˆè®°å½•å·²æ¸…é™¤ï¼');
            }
        },

        //æœ€ä½éš¾åº¦åˆ¤æ–­
        decreaseDifficulty: function () {
            if (this.currentLevel > 3) {
                this.currentLevel--;
                this.updateLevelDisplay();
                this.resetGame();
            } else {
                alert('å·²ç»æ˜¯æœ€ä½éš¾åº¦äº†ï¼');
            }
        },

        //æ›´æ–°æ˜¾ç¤ºå½“å‰ç­‰çº§
        updateLevelDisplay: function () {
            document.getElementById('current-level-display').textContent = `${this.currentLevel}Ã—${this.currentLevel}`;
            // åŒæ­¥æ›´æ–°Pingå®ä¾‹çš„éš¾åº¦
            if (this.pingInstance) {
                this.pingInstance.num = this.currentLevel;
            }
        },

        //è®°å½•æˆç»©
        recordScore: function () {
            const time = document.getElementById('timer').textContent;
            const moves = this.moveCount;
            const level = this.currentLevel;

            console.log('è®°å½•æˆç»©:', { level, time, moves });

            const score = {
                level: level,
                time: time,
                moves: moves,
                date: new Date().toLocaleString('zh-CN')
            };

            let rankings = JSON.parse(localStorage.getItem('puzzleRankings') || '[]');
            rankings.push(score);

            // æŒ‰æ—¶é—´æ’åº
            rankings.sort((a, b) => {
                const [aMin, aSec] = a.time.split(':').map(Number);
                const [bMin, bSec] = b.time.split(':').map(Number);
                return (aMin * 60 + aSec) - (bMin * 60 + bSec);
            });

            // åªä¿ç•™å‰10å
            rankings = rankings.slice(0, 5);
            localStorage.setItem('puzzleRankings', JSON.stringify(rankings));

            this.loadRankings();
        },

        //å°†ä¿¡æ¯ä¿å­˜åˆ°æœ¬åœ°å¹¶æ˜¾ç¤º
        loadRankings: function () {
            const rankings = JSON.parse(localStorage.getItem('puzzleRankings') || '[]');
            const tbody = document.getElementById('ranking-body');
            tbody.innerHTML = '';

            if (rankings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">æš‚æ— è®°å½•</td></tr>';
                return;
            }

            rankings.forEach((score, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${score.level}Ã—${score.level}</td>
                    <td>${score.time}</td>
                    <td>${score.moves}</td>
                    <td>${score.date}</td>
                `;
                tbody.appendChild(row);
            });
        },

        shareOnWechat: function () {
            alert('è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æåˆ†äº«é¡µé¢ï¼\næ¸¸æˆæˆç»©ï¼š' +
                document.getElementById('timer').textContent + ' ç”¨æ—¶ï¼Œ' +
                this.moveCount + ' æ­¥æ•°');
        },

        shareOnQQ: function () {
            alert('å·²ç”ŸæˆQQåˆ†äº«é“¾æ¥ï¼\næ¸¸æˆæˆç»©ï¼š' +
                document.getElementById('timer').textContent + ' ç”¨æ—¶ï¼Œ' +
                this.moveCount + ' æ­¥æ•°');
        },

        copyGameLink: function () {
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('æ¸¸æˆé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = window.location.href;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('æ¸¸æˆé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }
    };
</script>

</html>